#include <WiFi.h>
#include <HTTPClient.h>

// 1. WIFI SETTINGS
// Use a phone hotspot if possible (Universities often block device-to-device comms)
const char* ssid = "iPhone";
const char* password = "aaaaaaaa";

// 2. SERVER SETTINGS
// Find your laptop IP by running 'ipconfig' (Windows) or 'ifconfig' (Mac)
// Example: http://192.168.1.55:5001/get_pace
String serverName = "http://172.20.10.3:5001/get_pace"; 

// Timer to check for updates
unsigned long lastTime = 0;
unsigned long timerDelay = 2000; // Check every 2 seconds

// Pin Setup (Check your specific C3 board for the LED/Motor pin)
// On many C3 boards, the built-in LED is Pin 8 or 10.
int outputPin = 8; 

void setup() {
  Serial.begin(115200);
  pinMode(outputPin, OUTPUT);

  // Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting");
  while(WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("");
  Serial.print("Connected! IP: ");
  Serial.println(WiFi.localIP());
  
  // Quick buzz/blink to confirm startup
  digitalWrite(outputPin, HIGH);
  delay(500);
  digitalWrite(outputPin, LOW);
}

void loop() {
  // Only check if enough time has passed
  if ((millis() - lastTime) > timerDelay) {
    
    if(WiFi.status() == WL_CONNECTED){
      HTTPClient http;

      // Start connection to Python
      http.begin(serverName);
      
      // Send GET request
      int httpCode = http.GET();
      
      if (httpCode > 0) {
        // We got a response!
        String payload = http.getString();
        float targetPace = payload.toFloat();
        
        Serial.print("Target Pace: ");
        Serial.println(targetPace);

        // --- DO SOMETHING WITH THE DATA ---
        // Example: If pace is fast (< 12 min/mile), turn on LED
        if (targetPace > 0 && targetPace < 12) {
            digitalWrite(outputPin, HIGH); 
        } else {
            digitalWrite(outputPin, LOW);
        }
      }
      else {
        Serial.print("HTTP Error: ");
        Serial.println(httpCode);
      }
      http.end(); // Close connection
    }
    else {
      Serial.println("WiFi Disconnected");
    }
    lastTime = millis();
  }
}
